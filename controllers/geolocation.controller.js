const data = [
    {
      "id": "674f0a61f0d6197d7ac33b13",
      "from": "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266",
      "to": "0x976EA74026E726554dB657fA54763abd0C3a0aa9",
      "value": "14.0",
      "status": "Success",
      "gasUsed": "21000",
      "effectiveGasPrice": null,
      "blockHash": "0xe6066079b633e42c5b09ffc9a8451c95235798a0629d0c0fabdd029ac34abd45",
      "blockNumber": 7,
      "ip": "103.175.246.186",
      "timestamp": "2024-12-03T13:40:49.529+00:00",
      "__v": 0
    },
    {
      "id": "674f0cc0f0d6197d7ac33b15",
      "from": "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266",
      "to": "0x976EA74026E726554dB657fA54763abd0C3a0aa9",
      "value": "17.0",
      "status": "Success",
      "gasUsed": "21000",
      "effectiveGasPrice": null,
      "blockHash": "0x641e71d4d06ccc628fd7ba48bfe6a0f1591e608d6227a1f9fe2111bce64e5ae4",
      "blockNumber": 8,
      "ip": "103.175.246.186",
      "timestamp": "2024-12-03T13:50:56.130+00:00",
      "__v": 0
    },
    {
      "id": "674f0dabf0d6197d7ac33b17",
      "from": "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266",
      "to": "0x976EA74026E726554dB657fA54763abd0C3a0aa9",
      "value": "75.0",
      "status": "Success",
      "gasUsed": "21000",
      "effectiveGasPrice": null,
      "blockHash": "0xe82063fd27b508584a4e94de8db8a00c411fc9de18b9a32081227e6a71c6be9a",
      "blockNumber": 9,
      "ip": "103.175.246.186",
      "timestamp": "2024-12-03T13:54:51.924+00:00",
      "__v": 0
    },
    {
      "id": "674f1083f0d6197d7ac33b19",
      "from": "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266",
      "to": "0x9965507D1a55bcC2695C58ba16FB37d819B0A4dc",
      "value": "66.0",
      "status": "Success",
      "gasUsed": "21000",
      "effectiveGasPrice": null,
      "blockHash": "0x089eb6c50b6085a4ed4a351ae222df40d019684429725904aa0a2f52e62e6fef",
      "blockNumber": 10,
      "ip": "103.175.246.186",
      "timestamp": "2024-12-03T14:06:59.128+00:00",
      "__v": 0
    },
    {
      "id": "674f10cef0d6197d7ac33b1b",
      "from": "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266",
      "to": "0x9965507D1a55bcC2695C58ba16FB37d819B0A4dc",
      "value": "66.0",
      "status": "Success",
      "gasUsed": "21000",
      "effectiveGasPrice": null,
      "blockHash": "0x2057747a14dc7ed3f51df425099274e05e06d9a34a08f8e81361728254ec17ad",
      "blockNumber": 11,
      "ip": "103.175.246.186",
      "timestamp": "2024-12-03T14:08:14.590+00:00",
      "__v": 0
    },
    {
      "id": "674f1132f0d6197d7ac33b1d",
      "from": "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266",
      "to": "0x9965507D1a55bcC2695C58ba16FB37d819B0A4dc",
      "value": "66.0",
      "status": "Success",
      "gasUsed": "21000",
      "effectiveGasPrice": null,
      "blockHash": "0x2a96d8fd5f7ddef1fd6fb52342a7d8e3bb9443f8c0a2617c0afcd8347ace338d",
      "blockNumber": 12,
      "ip": "103.175.246.186",
      "timestamp": "2024-12-03T14:09:54.015+00:00",
      "__v": 0
    },
    {
      "id": "674f113bf0d6197d7ac33b1f",
      "from": "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266",
      "to": "0x9965507D1a55bcC2695C58ba16FB37d819B0A4dc",
      "value": "66.0",
      "status": "Success",
      "gasUsed": "21000",
      "effectiveGasPrice": null,
      "blockHash": "0x2ea7564903730b6ceb1799721736b8058bd0d096e63389e4566241fcba83f90a",
      "blockNumber": 13,
      "ip": "103.175.246.186",
      "timestamp": "2024-12-03T14:10:03.363+00:00",
      "__v": 0
    },
    {
      "id": "674f114cf0d6197d7ac33b21",
      "from": "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266",
      "to": "0x9965507D1a55bcC2695C58ba16FB37d819B0A4dc",
      "value": "66.0",
      "status": "Success",
      "gasUsed": "21000",
      "effectiveGasPrice": null,
      "blockHash": "0x4f430635512a84c3b5f4c3fa44051803b35371935ecc3e287b45d965813c1148",
      "blockNumber": 14,
      "ip": "103.175.246.186",
      "timestamp": "2024-12-03T14:10:20.420+00:00",
      "__v": 0
    },
    {
      "id": "674f1213f0d6197d7ac33b23",
      "from": "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266",
      "to": "0x14dC79964da2C08b23698B3D3cc7Ca32193d9955",
      "value": "655.0",
      "status": "Success",
      "gasUsed": "21000",
      "effectiveGasPrice": null,
      "blockHash": "0xb53be5f4fda899a5cde7713e07e4a316c6835b6668ae20bc5a463803548f6845",
      "blockNumber": 15,
      "ip": "103.175.246.186",
      "timestamp": "2024-12-03T14:13:39.878+00:00",
      "__v": 0
    },
    {
      "id": "674f142a8e02bebe1b3a535d",
      "from": "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266",
      "to": "0xa0Ee7A142d267C1f36714E4a8F75612F20a79720",
      "value": "124.0",
      "status": "Success",
      "gasUsed": "21000",
      "effectiveGasPrice": null,
      "blockHash": "0x48ffb26252969b887b3d1d30cd22cddd42467f594acd70feb10bd6a53af15946",
      "blockNumber": 1,
      "ip": "103.175.246.186",
      "timestamp": "2024-12-03T14:22:34.334+00:00",
      "__v": 0
    },
    {
      "id": "675963006af9d4b1d7b98557",
      "from": "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266",
      "to": "0x90F79bf6EB2c4f870365E785982E1f101E93b906",
      "value": "100.0",
      "status": "Success",
      "gasUsed": "21000",
      "effectiveGasPrice": null,
      "blockHash": "0x2254e9961897722b885475e573522b5acc76ad4dc0d7785fe905cdaa8f2f1c98",
      "blockNumber": 2,
      "ip": "125.20.225.38",
      "timestamp": "2024-12-11T10:01:35.847+00:00",
      "__v": 0
    },
    {
      "id": "67597ec9657e37a22978e12f",
      "from": "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266",
      "to": "0x70997970C51812dc3A010C7d01b50e0d17dc79C8",
      "value": "113.0",
      "status": "Success",
      "gasUsed": "21000",
      "effectiveGasPrice": null,
      "blockHash": "0x9bdec4227a964b8f6b714e8694e50d3d0b4063edec310d26473378a55f121410",
      "blockNumber": 1,
      "ip": "125.20.225.38",
      "timestamp": "2024-12-11T12:00:09.365+00:00",
      "__v": 0
    },
    {
      "id": "67598519657e37a22978e132",
      "from": "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266",
      "to": "0x15d34AAf54267DB7D7c367839AAf71A00a2C6A65",
      "value": "99.0",
      "status": "Success",
      "gasUsed": "21000",
      "effectiveGasPrice": null,
      "blockHash": "0x31244aa1085e2380995ff737be2981c50d26563d4e8cb4de53ccb6cc910bdd6f",
      "blockNumber": 2,
      "ip": "182.78.214.102",
      "timestamp": "2024-12-11T12:27:05.741+00:00",
      "__v": 0
    }
  ];

import axios from 'axios';
const getLocation = async (ip) =>{
    try {
        const response = await axios.get(`http://ip-api.com/json/${ip}`);
        return response.data;
    } catch (error) {
        console.error('Error getting location:', error);
        throw error;
    }
}

// distance between two IPs
const getDistanceBWTwoIps = async (ip1, ip2) => {
    try {
        const location1 = await getLocation(ip1);
        const location2 = await getLocation(ip2);
        const distance = getDistanceFromLatLonInKm(location1.lat, location1.lon, location2.lat, location2.lon);
        return distance;
    } catch (error) {
        console.error('Error getting distance:', error);
        throw error;
    }
}

// distance between two Lang & Latpoints in km
const getDistanceFromLatLonInKm = (lat1, lon1, lat2, lon2) => {
    const R = 6371; 
    const dLat = deg2rad(lat2 - lat1); 
    const dLon = deg2rad(lon2 - lon1);
    const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2)
        ;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    const d = R * c; 
    return d;
}

const deg2rad = (deg) => {
    return deg * (Math.PI / 180)
}

// locate my current Ip and lat long

const locateMyIp = async () => {
    try {
        const ipDetails = await axios.get('https://api.ipgeolocation.io/ipgeo?apiKey=ed1bc0430171454484653f9f32803535');
        const myIp = ipDetails.data.ip;
        const location = await getLocation(myIp);
        const cordinates = {
            lat : location.lat,
            lon : location.lon,
            ip : myIp
        };
        return cordinates;
    } catch (error) {
        console.error('Error getting location:', error);
        throw error;
    }
};

const compareLatAndLong = async(details) =>{
    const countriesData = [
        {
            "country": "North Korea",
            "latitude": 40.3399,
            "longitude": 127.5101
        },
        {
            "country": "United States",
            "latitude": 37.0902,
            "longitude": -95.7129
        },
        {
            "country": "Russia",
            "latitude": 61.5240,
            "longitude": 105.3188
        },
        {
            "country": "China",
            "latitude": 35.8617,
            "longitude": 104.1954
        },
        {
            "country": "United Kingdom",
            "latitude": 55.3781,
            "longitude": -3.4360
        },
        {
            "country": "Japan",
            "latitude": 36.2048,
            "longitude": 138.2529
        },
        {
            "country": "Hong Kong",
            "latitude": 22.3193,
            "longitude": 114.1694
        },
        {
            "country": "Canada",
            "latitude": 56.1304,
            "longitude": -106.3468
        },
        {
            "country": "British Virgin Islands",
            "latitude": 18.4207,
            "longitude": -64.6400
        },
        {
            "country": "South Korea",
            "latitude": 35.9078,
            "longitude": 127.7669
        }
    ];

    // calculate distance between my point to all countries
    const distances = countriesData.map((country) => {
        return {
            country: country.country,
            distance: getDistanceFromLatLonInKm(details.lat, details.lon, country.latitude, country.longitude)
        };
    });
    return distances;
}

const spamOrNot = async (data) => {
    const spamData = data.filter((transaction) => {
        return transaction.distance < 1500
    });
    return spamData;
};

const classify = async (ip) => {
    const ipdetails = ip;
    console.log(ipdetails);
    const result = await compareLatAndLong(ipdetails);
    const spamData = await spamOrNot(result);
    const resp = {
        spam: spamData.length > 1 ? true : false,
        possibleCountries: spamData,
        myIpDetails: ipdetails
    };
    return resp;
};

// console.log(await getDistanceBWTwoIps("103.175.246.186","182.78.214.102"));
// console.log(await locateMyIp());
// console.log(await compareLatAndLong(await locateMyIp()));
// const ipdetails = await getLocation("221.192.199.49");
// console.log(ipdetails);
// console.log(await getDistanceFromLatLonInKm(40.7687,114.886,35.8617,104.0954));
// console.log(await compareLatAndLong(ipdetails));
// console.log(await spamOrNot(await compareLatAndLong(ipdetails)));
// console.log(await classify());


export {
    getLocation,
    getDistanceBWTwoIps,
    classify,
    locateMyIp,
};
